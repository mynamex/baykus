
<div class="row">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-header border-0">
                <div class="row align-items-center">
                    <div class="col">
                        <h3 class="mb-0">Kapılar</h3>
                    </div>
                    <div class="col text-right">

                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <!-- Projects table -->
                <div class="col">
                    <div id="jsGridGates"></div>
                </div>

            </div>
        </div>
    </div>
</div>


{% block custom_js %}

    <script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }}"; </script>

    <script>

        $(document).ready(function() {

            var moduleTypes = [
                { Name: "", Id: 0 },
                { Name: "Intercom", Id: 1 },
                { Name: "GSM", Id: 2 },
            ];
            $("#jsGridGates").jsGrid({
                width: "100%",
                height: "360px",
                inserting: true,
                {#filtering: true,#}
                editing: true,
                sorting: true,
                autoload: true,
                paging: true,
                controller: {
                    loadData: function() {
                        let d = $.Deferred();

                        $.ajax({
                            method: 'GET', async:false,  dataType: "json",
                            url:"{% url 'staff_me:gates_view' %}",
                            data:{
                                "account_id" : {{ customer.pk }},
                                "csrfmiddlewaretoken": '{{ csrf_token }}' },
                        }).done(function(response) {

                            d.resolve(response.d_gates);
                        });
                        return d.promise();
                    }
                },
                onItemDeleting: function(args) {

                    alert("kaldırma işlemi için durumu pasif yapınız");
                },
                onItemInserting: function(args) {
                    $.ajax({
                        method: 'POST', dataType: "json", async:false,
                        url:"{% url 'staff_me:gates_view' %}",
                        data:{
                            "in_go":"create",
                            "account_id" : {{ customer.pk }},
                            "gate_name": args.item.gate_name,
                            "module_type": args.item.module_type,
                            "csrfmiddlewaretoken": '{{ csrf_token }}' },
                    }).done(function(response) {

                        if (response.result) {
                            const {d_gates} = response
                            $("#jsGridResidents").jsGrid("option", "data", d_gates);
                            MyToastInfo("Yeni Kapı Eklendi")
                            $(".jsgrid-insert-mode-button").click()
                        }
                        else {
                            if (response.status_message)
                                MyToastWarn(response.status_message);
                            args.cancel = true;
                        }
                    });
                },
                onItemUpdating: function(args) {

                    $.ajax({
                        method: 'POST', dataType: "json", async:false,
                        data:{
                            "in_go":"update",
                            "account_id" : {{ customer.pk }},
                            "gate_id": args.item.id,
                            "gate_name": args.item.gate_name,
                            "module_type": args.item.module_type,
                            "is_active": args.item.is_active,
                            "csrfmiddlewaretoken": '{{ csrf_token }}' },
                    }).done(function(response) {
                        if (response.result) {
                              const {d_gates} = response
                              $("#jsGridResidents").jsGrid("option", "data", d_gates);
                              MyToastSuccess("Güncelleme Başarılı")
                              $(".jsgrid-edit-mode-button").click()
                        }
                        else {
                            if (response.status_message)
                                MyToastWarn(response.status_message);
                            args.cancel = true;
                        }
                    });
                },
                rowClick: function (args) {
                    {#console.log(args.item.id);#}
                },
                fields: [
                    { name: "id", title: "Id", type: "number", width: 10, visible: false, validate: "required" },
                    { name: "gate_name", title: "Kapı", type: "text", width: 50,validate: "required", autosearch: true },
                    {
                        name: "module_type", width: 30, title: "Modül", type: "select", selectedIndex: 0,
                        items: [
                            { Name: "Seç", Id: ""},
                            { Name: "interkom", Id:1},
                            { Name: "gsm modül", Id:2},
                            { Name:"sabit hat", Id: 3}
                        ], valueField: "Id", textField: "Name", validate: function (value, item) {
                            return item.module_type;
                        }
                    },


                    { name: "is_active", title: "Durum", type: "checkbox", width: 30 },
                    { type: "control", deleteButton: false}
                ]
            });
        });
    </script>
{% endblock custom_js %}
